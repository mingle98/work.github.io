<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8"/>
<title>SourceMap è§£æå·¥å…·ï¼ˆå¸¦ Tab æ¨¡å¼åˆ‡æ¢ï¼‰</title>
<style>
  body { font-family: sans-serif; margin: 20px; background:#222; color:#ddd; }
  h1 { text-align: center; }
  .container { max-width: 700px; margin: auto; background:#333; padding:20px; border-radius:8px; }
  .tabs {
    display: flex;
    border-bottom: 1px solid #555;
    margin-bottom: 10px;
  }
  .tab {
    flex: 1;
    text-align: center;
    padding: 10px;
    cursor: pointer;
    user-select: none;
    background: #444;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    transition: background 0.15s;
  }
  .tab.active { background: #2a8; font-weight: bold; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  label { display: block; margin-top: 15px; }
  input[type="file"], input[type="text"] {
    width: 100%;
    margin-top: 5px; padding: 6px;
    box-sizing: border-box;
    background: #444;
    border: none;
    color: #ddd;
    border-radius: 4px;
    font-family: monospace;
  }
  button {
    margin-top: 20px;
    padding: 10px 0;
    width: 100%;
    font-size: 16px;
    background: #2a8;
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:disabled { background: #555; cursor: not-allowed; }
  pre {
    background: #111;
    padding: 10px;
    border-radius: 6px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .error { color: #f66; margin-top: 10px; }
  /* ===== æ¸©é¦¨æç¤ºæ ·å¼ä¼˜åŒ– ===== */
  .tip-cors {
    display: flex; align-items: flex-start; gap: 8px;
    color: #f8e66a;
    background: rgba(80,60,0,0.13);
    border-left: 5px solid #ffe082;
    padding: 12px 15px;
    border-radius: 6px;
    margin: 13px 0 -5px 0;
    align-items: center;
    font-size: 14px;
    position: relative;
    letter-spacing: .2px;
  }
  .tip-cors .icon {
    font-size: 20px;
    margin-right: 4px;
    user-select: none;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .tip-cors a {
    color: #ffd740;
    text-decoration: none;
    font-weight: bold;
    border-bottom: 1px dashed #ffd74038;
    transition: color 0.18s, border-color 0.18s;
    padding: 0 2px;
  }
  .tip-cors a:hover {
    color: #fffde4;
    border-bottom: 1px solid #ffd740;
    background: rgba(100,100,0,0.08);
  }
</style>
</head>
<body>
<h1>SourceMap è§£æå·¥å…·</h1>
<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="local">æœ¬åœ°æ–‡ä»¶</div>
    <div class="tab" data-tab="remote">è¿œç¨‹åŠ è½½</div>
  </div>

  <!-- æœ¬åœ°æ–‡ä»¶ Tab -->
  <div class="tab-content active" id="local">
    <label>
      é€‰æ‹©ç¼–è¯‘åçš„ JS æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      <input id="jsFileInput" type="file" accept=".js" />
    </label>
    <label>
      é€‰æ‹© SourceMap æ–‡ä»¶ (.map)
      <input id="mapFileInput" type="file" accept=".map,.json" />
    </label>
    <div id="localLoadResult"></div>
  </div>

  <!-- è¿œç¨‹åŠ è½½ Tab -->
  <div class="tab-content" id="remote">
    <label>
      è¿œç¨‹ JS æ–‡ä»¶ URLï¼ˆå¯é€‰ï¼‰
      <input id="remoteJsUrl" type="text" placeholder="https://example.com/app.js" />
    </label>
    <label>
      è¿œç¨‹ SourceMap URLï¼ˆå¿…å¡«ï¼‰
      <input id="remoteMapUrl" type="text" placeholder="https://example.com/app.js.map" />
    </label>
    <div class="tip-cors">
      <span class="icon">ğŸ’¡</span>
      ä¸ºé¿å…è·¨åŸŸæ‹‰å–Mapæ–‡ä»¶å¤±è´¥ï¼Œè¯·å®‰è£…å¹¶å¼€å¯
      <a href="https://chromewebstore.google.com/detail/cors-unblock/hadoojkfknbjgoppkecpgamiajljiief?hl=zh-CN&utm_source=ext_sidebar"
         target="_blank" rel="noopener noreferrer">
        ã€CORS Unblockã€‘
      </a>
      Chromeæ’ä»¶
    </div>
    <button id="loadRemoteBtn" disabled>åŠ è½½è¿œç¨‹ SourceMap</button>
    <div id="remoteLoadResult"></div>
  </div>

  <!-- å…¬å…±è¡Œåˆ—å·è¾“å…¥å’Œè§£ææŒ‰é’® -->
  <label style="margin-top:30px;">
    ç¼–è¯‘åä»£ç è¡Œåˆ—å· (æ ¼å¼ï¼šè¡Œ:åˆ—ï¼Œæ¯”å¦‚ 1:324501)
    <input id="lineColumnInput" type="text" placeholder="1:0" />
  </label>
  <button id="parseBtn" disabled>è§£æ</button>
  <div id="result"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/source-map@0.7.4/dist/source-map.min.js"></script>
<script>
  sourceMap.SourceMapConsumer.initialize({
    'lib/mappings.wasm': 'https://cdn.jsdelivr.net/npm/source-map@0.7.4/lib/mappings.wasm'
  });

  // Tabåˆ‡æ¢
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const selected = tab.dataset.tab;
      tabContents.forEach(tc => {
        tc.id === selected ? tc.classList.add('active') : tc.classList.remove('active');
      });
      resetStateByTab(selected);
    });
  });

  // å…ƒç´ å¼•ç”¨
  const remoteJsUrlInput = document.getElementById('remoteJsUrl');
  const remoteMapUrlInput = document.getElementById('remoteMapUrl');
  const loadRemoteBtn = document.getElementById('loadRemoteBtn');
  const remoteLoadResult = document.getElementById('remoteLoadResult');
  const jsFileInput = document.getElementById('jsFileInput');
  const mapFileInput = document.getElementById('mapFileInput');
  const localLoadResult = document.getElementById('localLoadResult');
  const lineColumnInput = document.getElementById('lineColumnInput');
  const parseBtn = document.getElementById('parseBtn');
  const resultDiv = document.getElementById('result');

  // å½“å‰åŠ è½½çš„ SourceMap å†…å®¹
  let mapContent = null;
  // è®°å½•å½“å‰æ¨¡å¼
  let currentMode = 'local'; // default

  // ç›‘å¬æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
  mapFileInput.addEventListener('change', () => {
    if (currentMode !== 'local') return;
    const file = mapFileInput.files[0];
    localLoadResult.innerHTML = '';
    mapContent = null;
    parseBtn.disabled = true;
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        mapContent = JSON.parse(e.target.result);
        localLoadResult.innerHTML = '<pre>æœ¬åœ° SourceMap æ–‡ä»¶å·²åŠ è½½æˆåŠŸ</pre>';
        parseBtn.disabled = validateInputs();
        remoteLoadResult.innerHTML = '';
        resultDiv.innerHTML = '';
      } catch (error) {
        mapContent = null;
        localLoadResult.innerHTML = '<div class="error">é”™è¯¯ï¼šæœ¬åœ° SourceMap æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚</div>';
      }
    };
    reader.readAsText(file);
  });

  // è¿œç¨‹åŠ è½½æŒ‰é’®å¯ç”¨æ§åˆ¶
  function checkRemoteInputs() {
    loadRemoteBtn.disabled = !remoteMapUrlInput.value.trim();
  }
  remoteJsUrlInput.addEventListener('input', checkRemoteInputs);
  remoteMapUrlInput.addEventListener('input', checkRemoteInputs);

  loadRemoteBtn.addEventListener('click', async () => {
    if (currentMode !== 'remote') return;
    const mapUrl = remoteMapUrlInput.value.trim();
    remoteLoadResult.innerHTML = '<pre>æ­£åœ¨åŠ è½½è¿œç¨‹ SourceMap ...</pre>';
    mapContent = null;
    parseBtn.disabled = true;
    try {
      const resp = await fetch(mapUrl, {cache: 'no-cache'});
      if (!resp.ok) throw new Error(`HTTP çŠ¶æ€ç  ${resp.status}`);
      const json = await resp.json();
      mapContent = json;
      remoteLoadResult.innerHTML = '<pre>è¿œç¨‹ SourceMap æ–‡ä»¶åŠ è½½æˆåŠŸ</pre>';
      localLoadResult.innerHTML = '';
      parseBtn.disabled = validateInputs();
      resultDiv.innerHTML = '';
    } catch(err) {
      remoteLoadResult.innerHTML = `<div class="error">åŠ è½½è¿œç¨‹ SourceMap å¤±è´¥ï¼š${err.message}</div>`;
    }
  });

  // è¡Œåˆ—å·æ ¼å¼æ ¡éªŒ
  function validateInputs() {
    if (!mapContent) return false;
    const val = lineColumnInput.value.trim();
    if (!val) return false;
    const arr = val.split(':');
    if (arr.length !== 2) return false;
    const line = parseInt(arr[0], 10);
    const col = parseInt(arr[1], 10);
    if (!Number.isInteger(line) || line < 1) return false;
    if (!Number.isInteger(col) || col < 0) return false;
    return true;
  }

  lineColumnInput.addEventListener('input', () => {
    parseBtn.disabled = !validateInputs();
    resultDiv.innerHTML = '';
  });

  parseBtn.addEventListener('click', async () => {
    resultDiv.innerHTML = '<pre>è§£æä¸­...</pre>';
    try {
      const val = lineColumnInput.value.trim();
      const [lineStr, colStr] = val.split(':');
      const line = parseInt(lineStr, 10);
      const column = parseInt(colStr, 10);

      const consumer = await new sourceMap.SourceMapConsumer(mapContent);
      const pos = consumer.originalPositionFor({
        line: line,
        column: column,
        bias: sourceMap.SourceMapConsumer.LEAST_UPPER_BOUND
      });
      consumer.destroy();

      if (pos.source === null) {
        resultDiv.innerHTML = '<div class="error">æœªæ‰¾åˆ°å¯¹åº”çš„æºæ–‡ä»¶ä½ç½®ã€‚</div>';
      } else {
        let html = `<pre>å¯¹åº”æºæ–‡ä»¶è·¯å¾„: ${pos.source}\nè¡Œå·: ${pos.line}\nåˆ—å·: ${pos.column}`;
        if (pos.name) {
          html += `\nç¬¦å·å: ${pos.name}`;
        }
        html += '</pre>';
        resultDiv.innerHTML = html;
      }
    } catch (err) {
      resultDiv.innerHTML = `<div class="error">è§£æå‡ºé”™ï¼š${err.message}</div>`;
    }
  });

  // æ ¹æ®æ¨¡å¼åˆ‡æ¢ï¼Œé‡ç½®ç›¸å…³çŠ¶æ€
  function resetStateByTab(mode) {
    currentMode = mode;
    mapContent = null;
    parseBtn.disabled = true;
    resultDiv.innerHTML = '';
    lineColumnInput.value = '';
    // æ¸…ç©ºåŠ è½½æç¤º
    localLoadResult.innerHTML = '';
    remoteLoadResult.innerHTML = '';
    // é‡ç½®è¾“å…¥æ§ä»¶çŠ¶æ€
    if (mode === 'local') {
      jsFileInput.value = '';
      mapFileInput.value = '';
    } else if (mode === 'remote') {
      remoteJsUrlInput.value = '';
      remoteMapUrlInput.value = '';
      loadRemoteBtn.disabled = true;
    }
  }
</script>
</body>
</html>
